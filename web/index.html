<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>KYC MVP Demo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body {
        font-family: system-ui, sans-serif;
        max-width: 900px;
        margin: 2rem auto;
        padding: 0 1rem;
      }
      .card {
        border: 1px solid #ddd;
        border-radius: 12px;
        padding: 1rem;
        margin-bottom: 1rem;
      }
      .row {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
      }
      .row > div {
        flex: 1 1 280px;
      }
      pre {
        background: #f6f8fa;
        padding: 1rem;
        overflow: auto;
        border-radius: 8px;
        white-space: pre-wrap;
      }
      button {
        padding: 0.6rem 1rem;
      }
      label {
        display: block;
        margin: 0.3rem 0;
      }
      input[type="file"] {
        width: 100%;
      }
      video,
      canvas,
      img.preview {
        width: 100%;
        max-width: 320px;
        border-radius: 12px;
        border: 1px solid #ddd;
        background: #000;
      }
      .selfie-status {
        font-size: 0.9rem;
        color: #555;
      }
      .selfie-actions {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
        margin-top: 0.5rem;
      }
    </style>
  </head>
  <body>
    <h1>KYC MVP Demo</h1>
    <p>
      Upload an ID (front) and capture a live selfie to run the free KYC
      pipeline. This is a demo and not compliance-grade.
    </p>

    <div class="card">
      <form id="kyc-form">
        <div class="row">
          <div>
            <label>ID Front (required)</label>
            <input
              type="file"
              id="id_front"
              name="id_front"
              accept="image/*"
              required
            />
          </div>
          <div>
            <label>ID Back (optional)</label>
            <input type="file" id="id_back" name="id_back" accept="image/*" />
          </div>
          <div>
            <label>Live Selfie Capture (required)</label>
            <div>
              <video id="selfie-video" playsinline autoplay muted></video>
              <img
                id="selfie-preview"
                class="preview"
                alt="Captured selfie preview"
                style="display: none; margin-top: 0.5rem;"
              />
              <div class="selfie-actions">
                <button type="button" id="start-camera">Start Camera</button>
                <button type="button" id="capture-selfie" disabled>
                  Capture Selfie
                </button>
                <button type="button" id="retake-selfie" disabled>
                  Retake
                </button>
              </div>
              <p class="selfie-status" id="selfie-status">
                Camera idle. Start the camera to capture a live selfie.
              </p>
            </div>
          </div>
        </div>
        <div class="row">
          <div>
            <label>Full Name (optional)</label>
            <input
              type="text"
              id="full_name"
              name="full_name"
              placeholder="Jane Doe"
            />
          </div>
          <div>
            <label>Date of Birth (YYYY-MM-DD, optional)</label>
            <input type="text" id="dob" name="dob" placeholder="1990-01-01" />
          </div>
        </div>
        <p><button type="submit">Run KYC</button></p>
      </form>
    </div>

    <div class="card">
      <h3>Result</h3>
      <pre id="result"></pre>
    </div>

    <script>
      const form = document.getElementById("kyc-form");
      const out = document.getElementById("result");
      const video = document.getElementById("selfie-video");
      const preview = document.getElementById("selfie-preview");
      const startBtn = document.getElementById("start-camera");
      const captureBtn = document.getElementById("capture-selfie");
      const retakeBtn = document.getElementById("retake-selfie");
      const statusEl = document.getElementById("selfie-status");

      let stream = null;
      let capturedBlob = null;

      async function startCamera() {
        if (stream) {
          statusEl.textContent = "Camera already running.";
          return;
        }
        try {
          stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: "user", width: { ideal: 640 } },
            audio: false,
          });
          video.srcObject = stream;
          captureBtn.disabled = false;
          retakeBtn.disabled = true;
          preview.style.display = "none";
          statusEl.textContent = "Camera active. Capture when ready.";
        } catch (err) {
          statusEl.textContent =
            "Unable to access camera: " +
            (err && err.message ? err.message : err);
        }
      }

      function stopCamera() {
        if (!stream) return;
        stream.getTracks().forEach((track) => track.stop());
        stream = null;
        video.srcObject = null;
        captureBtn.disabled = true;
      }

      async function captureSelfie() {
        if (!stream) {
          statusEl.textContent = "Camera not running. Start camera first.";
          return;
        }
        const track = stream.getVideoTracks()[0];
        const settings = track.getSettings();
        const canvas = document.createElement("canvas");
        canvas.width = settings.width || video.videoWidth || 640;
        canvas.height = settings.height || video.videoHeight || 480;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        await new Promise((resolve) => {
          canvas.toBlob(
            (blob) => {
              if (!blob) {
                statusEl.textContent = "Failed to capture selfie. Try again.";
                return resolve();
              }
              capturedBlob = blob;
              preview.src = URL.createObjectURL(blob);
              preview.style.display = "block";
              statusEl.textContent = "Selfie captured. Submit the form or retake.";
              retakeBtn.disabled = false;
              resolve();
            },
            "image/jpeg",
            0.95
          );
        });
      }

      function retakeSelfie() {
        capturedBlob = null;
        preview.style.display = "none";
        statusEl.textContent = "Capture another selfie when ready.";
        retakeBtn.disabled = true;
      }

      startBtn.addEventListener("click", startCamera);
      captureBtn.addEventListener("click", captureSelfie);
      retakeBtn.addEventListener("click", retakeSelfie);

      window.addEventListener("beforeunload", () => {
        stopCamera();
      });

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        if (!capturedBlob) {
          statusEl.textContent = "Capture a selfie before submitting.";
          return;
        }
        out.textContent = "Running...";
        const fd = new FormData(form);
        // Remove any stale selfie value and append the live capture
        fd.delete("selfie");
        const selfieFile = new File([capturedBlob], "selfie.jpg", {
          type: "image/jpeg",
        });
        fd.append("selfie", selfieFile);
        try {
          const res = await fetch("/api/kyc/verify", {
            method: "POST",
            body: fd,
          });
          const ct = res.headers.get("content-type") || "";
          if (!res.ok) {
            const text = ct.includes("application/json")
              ? JSON.stringify(await res.json(), null, 2)
              : await res.text();
            out.textContent = `HTTP ${res.status} ${res.statusText}\n${text}`;
            return;
          }
          const data = ct.includes("application/json")
            ? await res.json()
            : await res.text();
          out.textContent =
            typeof data === "string" ? data : JSON.stringify(data, null, 2);
        } catch (err) {
          out.textContent =
            "Network or parsing error: " +
            (err && err.message ? err.message : err);
        }
      });
    </script>
  </body>
</html>
